<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Using Private Repositories and Registries :: Tekton Tutorial</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/tekton-tutorial/tekton-tutorial/private_reg_repos.html">
    <link rel="prev" href="workspaces.html">
    <meta name="generator" content="Antora 2.3.3">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-developer-demos.github.io/tekton-tutorial">Tekton Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="tekton-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="setup.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#tekton-prerequisites">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#download-tutorial-sources">Download Tutorial Sources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#kubernetes-cluster">Choose your Kubernetes Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#tutorial-dev-env">Development Environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#deploy-tekton">Install Tekton</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#install-tekton-cli">Install Tekton CLI</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="pipeline-resources.html">Pipeline Resources</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipeline-resources.html#tekton-res-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipeline-resources.html#tekton-res-create">Create Pipeline Resource</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipeline-resources.html#tekton-res-deploy">Deploy Pipeline Resource</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipeline-resources.html#tkn-see-what-you-have-deployed">See what you have deployed</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="tasks.html">Tasks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="tasks.html#tekton-tasks]">Tasks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tasks.html#tekton-task-clone">Clone Source Code</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-task-list-ws">Know your Workspace</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-task-clustertask">Cluster Task</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-tasks-points-to-ponder">Points to Ponder</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="tasks.html#tekton-task-build-sources">Build Cloud Native Application</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tasks.html#build-sources">Build Sources</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tasks.html#build-linux-image">Build Image</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tasks.html#push-linux-image">Push Image</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-task-deploy">Deploy Task</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-task-run">TaskRun</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-test-task-output">Test Task Output</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-task-step-template">Step Template</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-task-cleanup">Clean</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="pipelines.html">Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipelines.html#tekton-add-tasks">Add Tasks from Catalog</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipelines.html#tekton-pipeline-create">Create Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipelines.html#tekton-pipeline-deploy">Deploy Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipelines.html#tekton-pipeline-run">Run Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipelines.html#tekton-test-pipeline">Test Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipelines.html#tekton-pipeline-cleanup">Clean</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="workspaces.html">Workspaces</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="workspaces.html#ws-overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="workspaces.html#ws-prepare">Prepare for Using Workspaces</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-tasks-deploy">Deploy Tasks from Catalog</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-deploy-nexus">Deploy Nexus</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-create-maven-settings-cm">Create Maven Settings</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-deploy-knative">Deploy Knative</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-check-sc">Check Default Storage Class</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="workspaces.html#ws-pipeline-overview">Java Application Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="workspaces.html#ws-use-pvc">Using Persistent Volumes as Workspace</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-use-pvc-git-clone">Git Clone TaskRun</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-pvc-points-to-ponder">Points to Ponder</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="workspaces.html#ws-use-cm">Using ConfigMap as Workspace</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-use-cm-mvn-run">Run maven Task</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#use-cm-points-to-ponder">Points to Ponder</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="workspaces.html#ws-deploy-pipeline">Deploy Pipeline</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-create-pipeline">Create Pipeline</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-run-pipeline">Run Pipeline</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-verify-service">Verify Deployed Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="workspaces.html#tekton-ws-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="private_reg_repos.html">Using Private Registries and Repositories</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tkn-prr-overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#tekton-pull-from-remote-repo">Pulling from Private Source Repository</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#tekton-github-repo-secret">Create Github PAT Secret</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#tekton-github-sa">Create Service Account</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#tekton-create-clone-pipeline">Create And Run Pipeline</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#tekton-push-to-external-reg">Pushing To External Registry</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#tekton-push-registry-secret">Create Registry Secret</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#tekton-build-sa">Create Service Account</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#tekton-create-build-push-pipeline">Create And Run Pipeline</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tekton-remote-ref-points">Points to Ponder</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tekton-auth-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Tekton Tutorial</a></li>
    <li><a href="private_reg_repos.html">Using Private Registries and Repositories</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-developer-demos/tekton-tutorial/edit/master/documentation/modules/ROOT/pages/private_reg_repos.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Using Private Repositories and Registries</h1>
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This chapter build is in progress, expect to change and not working as expected
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At the end of this chapter you will be able to :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tekton Authentication Secrets</p>
</li>
<li>
<p>How to push linux contianer image to external registry</p>
</li>
<li>
<p>How to clone from a private Github respository</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tkn-prr-overview"><a class="anchor" href="#tkn-prr-overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In many parctical usecase you might need to pull from private Git repsoitories or might need to push to external container registry such as <a href="https://quay.io">Quay.io</a>. In both the cases the access requires you to authenticate. With Tekton this is achieved using the Kubernetes Service Account(SA) and Kubernetes Secret.</p>
</div>
<div class="paragraph">
<p>If you are not in tutorial chapter folder, then navigate to the folder:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd $TUTORIAL_HOME/private_repos_reg</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let us create a new namespace called <code>workspace-auth-demo</code> and switch to that namespace context.</p>
</div>
<div class="admonitionblock note assumptions">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="ASSUMPTIONS"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>It is assumed that you have completed <a href="workspaces.html" class="page">Workspaces</a> and the reusing the same namespace that was <a href="workspaces.html#ws-prepare" class="page">prepared</a> in that chapter.</p>
</li>
<li>
<p>You have container registry account with <a href="https://quay.io">Quay.io</a> or <a href="https://hub.docker.com">Docker Hub</a></p>
</li>
<li>
<p>You have GitHub account and a private repository</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tekton-pull-from-remote-repo"><a class="anchor" href="#tekton-pull-from-remote-repo"></a>Pulling from Private Source Repository</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this exercise we will see how to pull i.e. clone the source code from the private source reporsitory. For this example we will use the GitHub as the remote source repository.</p>
</div>
<div class="paragraph">
<p>To be able to run this exercise you need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A remote GitHub Repository, you can pull fork the <a href="https://github.com/redhat-developer-demos/tekton-helloworld" class="bare">https://github.com/redhat-developer-demos/tekton-helloworld</a> and push that as your private repository</p>
</li>
<li>
<p>A <a href="https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token">GitHub Personal Access Token(PAT)</a> to access the remote repository.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Set the requried environment variables to be used when creating the github-pat-secret:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export GITHUB_USERNAME='&lt;your github.com username&gt;'
export TEKTON_TUTORIAL_GITHUB_PAT='&lt;your github.com username personal accesstoken&gt;'</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="tekton-github-repo-secret"><a class="anchor" href="#tekton-github-repo-secret"></a>Create Github PAT Secret</h3>
<div class="paragraph">
<p>Create the Kubernetes secret that can hold your GitHub.com credentials:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create secret -n workspace-auth-demo generic github-pat-secret --dry-run=client -o yaml \
  | yq w - type kubernetes.io/basic-auth \
  | yq w - stringData.username $GITHUB_USERNAME \
  | yq w - stringData.password $TEKTON_TUTORIAL_GITHUB_PAT \
  | kubectl apply -f -</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">secret/github-pat-secret created</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tekton-github-pat-annoate"><a class="anchor" href="#tekton-github-pat-annoate"></a>Annotate Secret to be used with GitHub.com</h3>
<div class="paragraph">
<p>To make Tekton use the Secret <code>github-pat-secret</code> with github.com, we need to annotate the Secret with <code>tekton.dev/git-0=https://github.com</code>.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl annotate -n workspace-auth-demo secret github-pat-secret \
  "tekton.dev/git-0=https://github.com"</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">secret/github-pat-secret annotated</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify the github-pat-secret as right type, annoations and credential values:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get -n workspace-auth-demo secret github-pat-secret -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command should show an output(trimmed for brevity) as shown in the following listing, with your GitHub.com username and PAT.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">apiVersion: v1
data:
  password: REDACTED
  username: REDACTED
kind: Secret
metadata:
  annotations:
    <mark>tekton.dev/git-0: https://github.com</mark>
  name: github-pat-secret
  namespace: workspace-auth-demo
<mark>type: kubernetes.io/basic-auth</mark></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tekton-github-sa"><a class="anchor" href="#tekton-github-sa"></a>Create Service Account</h3>
<div class="paragraph">
<p>Let us create a Kubernetes ServiceAccount that could be used pull from the private GitHub repository:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create sa -n workspace-auth-demo github-bot</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">serviceaccount/github-bot created</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tekton-patch-github-sa"><a class="anchor" href="#tekton-patch-github-sa"></a>Patch Service Account</h3>
<div class="paragraph">
<p>Now patch the <code>github-bot</code> service account to use the <code>github-pat-secret</code> credentials:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl patch serviceaccount github-bot \
  -p '{"secrets": [{"name": "github-pat-secret"}]}'</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">serviceaccount/github-bot patched</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lets verify if the service account has the secret added:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get sa -n workspace-auth-demo github-bot -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command should show an output(trimmed for brevity) like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: ServiceAccount
metadata:
  name: github-bot
  namespace: workspace-auth-demo
secrets:
<mark>- name: github-pat-secret</mark>
- name: build-bot-token-8nl2v</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tekton-create-clone-pipeline"><a class="anchor" href="#tekton-create-clone-pipeline"></a>Create Pipeline</h3>
<div class="paragraph">
<p>Create the git clone pipeline which will clone from the private GitHub repo and simply list the contents:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n workspace-auth-demo -f <a href="https://github.com/redhat-developer-demos/tekton-tutorial/blob/master/private_repos_reg/secretworld-app-clone.yaml" target="_blank" rel="noopener">secretworld-app-clone.yaml</a></code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">pipeline.tekton.dev/secretworld-app-clone created</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tekton-run-clone-pipeline"><a class="anchor" href="#tekton-run-clone-pipeline"></a>Run Pipeline</h3>
<div class="paragraph">
<p>Ensure that the pipeline run has been set to run with the Service Account <code>github-bot</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  generateName: secretworld-app-clone-
  labels:
    tekton.dev/pipeline: secretworld-app-clone
spec:
  serviceAccountName: <mark>github-bot</mark>
  pipelineRef:
    name: secretworld-app-clone
  params:
    - name: private-github-repo-url
      value: https://github.com/redhat-developer-demos/tekton-secretworld <i class="conum" data-value="1"></i><b>(1)</b>
  workspaces:
    - name: source
      persistentVolumeClaim:
        claimName: tekton-tutorial-sources</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Please make sure you have updated the private GitHub repository to match your private repository</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the pipeline:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create -n workspace-auth-demo -f secretworld-app-clone-run.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>View the pipeline run logs using,</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn pr logs -f -a $(tkn pr ls -n workspace-auth-demo | awk 'NR==2{print $1}')</code></pre>
</div>
</div>
<div class="paragraph">
<p>A successful clone from private repo will show the following output ( trimmed brevity):</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[clone-sources : credential-initializer] {"level":"info","ts":1595922122.9077983,"caller":"creds-init/main.go:44","msg":"Credentials initialized."}

[clone-sources : clone] + CHECKOUT_DIR=/workspace/output/
[clone-sources : clone] + '[[' true '==' true ]]
[clone-sources : clone] + cleandir
[clone-sources : clone] + '[[' -d /workspace/output/ ]]
[clone-sources : clone] + rm -rf /workspace/output//Dockerfile /workspace/output//README.md /workspace/output//k8s /workspace/output//mvnw /workspace/output//mvnw.cmd /workspace/output//pom.xml /workspace/output//src
[clone-sources : clone] + rm -rf /workspace/output//.dockerignore /workspace/output//.git /workspace/output//.gitignore /workspace/output//.mvn
[clone-sources : clone] + rm -rf '/workspace/output//..?*'
[clone-sources : clone] + test -z
[clone-sources : clone] + test -z
[clone-sources : clone] + test -z
[clone-sources : clone] + /ko-app/git-init -url https://github.com/redhat-developer-demos/tekton-secretworld -revision master -refspec  -path /workspace/output/ '-sslVerify=true' '-submodules=true' -depth 1
[clone-sources : clone] {"level":"info","ts":1595922137.4565356,"caller":"git/git.go:139","msg":"Successfully cloned https://github.com/redhat-developer-demos/tekton-secretworld @ 5250e1fa185805373e620d1c04a0c48129efd2ee (grafted, HEAD, origin/master) in path /workspace/output/"}
[clone-sources : clone] {"level":"info","ts":1595922137.4990256,"caller":"git/git.go:180","msg":"Successfully initialized and updated submodules in path /workspace/output/"}
[clone-sources : clone] + cd /workspace/output/
[clone-sources : clone] + git+ tr -d '\n'
[clone-sources : clone]  rev-parse HEAD
[clone-sources : clone] + RESULT_SHA=5250e1fa185805373e620d1c04a0c48129efd2ee
[clone-sources : clone] + EXIT_CODE=0
[clone-sources : clone] + '[' 0 '!=' 0 ]
[clone-sources : clone] + echo -n 5250e1fa185805373e620d1c04a0c48129efd2ee

[list-cloned-repo : credential-initializer] {"level":"info","ts":1595922139.7837844,"caller":"creds-init/main.go:44","msg":"Credentials initialized."}


[list-cloned-repo : list-directory] total 44
[list-cloned-repo : list-directory] drwxr-xr-x    4 root     root          4096 Jul 28 07:42 src
[list-cloned-repo : list-directory] -rw-r--r--    1 root     root          4147 Jul 28 07:42 pom.xml
[list-cloned-repo : list-directory] -rwxr-xr-x    1 root     root          6607 Jul 28 07:42 mvnw.cmd
[list-cloned-repo : list-directory] -rwxr-xr-x    1 root     root         10069 Jul 28 07:42 mvnw
[list-cloned-repo : list-directory] drwxr-xr-x    2 root     root          4096 Jul 28 07:42 k8s
[list-cloned-repo : list-directory] -rw-r--r--    1 root     root           111 Jul 28 07:42 README.md
[list-cloned-repo : list-directory] -rw-r--r--    1 root     root            87 Jul 28 07:42 Dockerfile

[list-cloned-repo : show-readme] ü•≥ Yay! üéâ
[list-cloned-repo : show-readme]
[list-cloned-repo : show-readme] You have successfully cloned from private GitHub repository. üëèüëè
[list-cloned-repo : show-readme]
[list-cloned-repo : show-readme] üò∫ Tekton Rocks!! üöÄ</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tekton-push-to-external-reg"><a class="anchor" href="#tekton-push-to-external-reg"></a>Pushing to external registry</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To able push to external container registry, its requried that the Pipline is run with a ServiceAccount that has container registry credentials configured via ServiceAccount secrets.  Kubernetes provider a Secret type called <code>docker-registry</code>, that can be used to configure the container registry credentials.</p>
</div>
<div class="paragraph">
<p>Set the requried environment variables to be used when creating the container-registry-secret:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export CONTAINER_REGISTRY_SERVER='https://quay.io' <i class="conum" data-value="1"></i><b>(1)</b>
export CONTAINER_REGISTRY_USER='&lt;your registry user&gt;'
export CONTAINER_REGISTRY_PASSWORD='&lt;your registry user password&gt;'</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The container registry server URL, for Quay.io its <a href="https://quay.io" class="bare">https://quay.io</a> and for DockerHub it is <a href="https://index.docker.io/v2/" class="bare">https://index.docker.io/v2/</a></td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="tekton-push-registry-secret"><a class="anchor" href="#tekton-push-registry-secret"></a>Create Container Registry Secret</h3>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create secret -n workspace-auth-demo docker-registry container-registry-secret \
  --docker-server=$CONTAINER_REGISTRY_SERVER \
  --docker-username=$CONTAINER_REGISTRY_USER \
  --docker-password=$CONTAINER_REGISTRY_PASSWORD</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">secret/container-registry-secret created</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tekton-build-sa"><a class="anchor" href="#tekton-build-sa"></a>Create Service Account</h3>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create sa -n workspace-auth-demo build-bot</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">serviceaccount/build-bot created</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tekton-patch-build-sa"><a class="anchor" href="#tekton-patch-build-sa"></a>Patch Service Account</h3>
<div class="paragraph">
<p>Now patch the <code>build-bot</code> service account to use the <code>container-registry-secret</code> credentials:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl patch serviceaccount build-bot \
  -p '{"secrets": [{"name": "container-registry-secret"}]}'</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">serviceaccount/build-bot patched</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lets verify if the service account has the secret added:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get sa -n workspace-auth-demo build-bot -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command should show an output like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: ServiceAccount
metadata:
  creationTimestamp: "2020-07-28T03:34:32Z"
  name: build-bot
  namespace: auth-demo
  resourceVersion: "53879"
  selfLink: /api/v1/namespaces/auth-demo/serviceaccounts/build-bot
  uid: 628067fd-91d1-4cdd-b6a6-88b4f7280ff0
secrets:
<mark>- name: container-registry-secret</mark>
- name: build-bot-token-8nl2v</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tekton-create-build-push-pipeline"><a class="anchor" href="#tekton-create-build-push-pipeline"></a>Create Pipeline</h3>
<div class="paragraph">
<p>Create the build and push app pipeline:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n workspace-auth-demo \
  -f <a href="https://github.com/redhat-developer-demos/tekton-tutorial/blob/master/private_repos_reg/helloworld-app-build.yaml" target="_blank" rel="noopener">helloworld-app-build.yaml</a></code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">pipeline.tekton.dev/helloworld-app-build created</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tekton-run-build-push-pipeline"><a class="anchor" href="#tekton-run-build-push-pipeline"></a>Run Pipeline</h3>
<div class="paragraph">
<p>Ensure that the pipeline run has been set to run with the Service Account <code>build-bot</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  generateName: helloworld-app-build-
  labels:
    tekton.dev/pipeline: helloworld-app-build
spec:
  serviceAccountName: <mark>build-bot</mark>
  pipelineRef:
    name: helloworld-app-build
  workspaces:
    - name: maven-settings
      configmap:
        name: maven-settings
    - name: source
      persistentVolumeClaim:
        emptyDir: tekton-tutorial-sources</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the pipeline:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create -n workspace-auth-demo -f helloworld-app-build-run.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>View the pipeline run logs using,</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn pr logs -f -a $(tkn pr ls -n workspace-auth-demo | awk 'NR==2{print $1}')</code></pre>
</div>
</div>
<div class="paragraph">
<p>A successful build and push will show the following output ( trimmed brevity):</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">...
[build-java-app-image : push] + buildah --storage-driver=overlay push --tls-verify=true --digestfile /workspace/source/image-digest quay.io/rhdevelopers/tekton-helloworld docker://quay.io/rhdevelopers/tekton-helloworld
[build-java-app-image : push] Getting image source signatures
[build-java-app-image : push] Copying blob sha256:90c2e42f948b524cf98005073e0b0aa2065160abf9e8b314976c064e270d92ac
[build-java-app-image : push] Copying blob sha256:869b43e5dca37fa63d84e9bc588613678c4fe6fa2072a72a6ab5487424db2891
[build-java-app-image : push] Copying blob sha256:f9ddbcc4e7954a705b700c35c5e5beceabd86af121a6e561d86437a8512a6be6
[build-java-app-image : push] Copying blob sha256:7b08010864ba4c7ce9dfe1b90244b459b77c0387051659d37454783d10ab1113
[build-java-app-image : push] Copying config sha256:5bd61d725dc47d1f8b7c225d8d52f2730321cadad65988a0de60300a711a2e2b
[build-java-app-image : push] Writing manifest to image destination
[build-java-app-image : push] Copying config sha256:5bd61d725dc47d1f8b7c225d8d52f2730321cadad65988a0de60300a711a2e2b
[build-java-app-image : push] Writing manifest to image destination
[build-java-app-image : push] Storing signatures

[build-java-app-image : digest-to-results] + cat /workspace/source/image-digest
[build-java-app-image : digest-to-results] + tee /tekton/results/IMAGE_DIGEST
[build-java-app-image : digest-to-results] <mark>sha256:0e9e267a96f1ea48fe00642cd82ef689e44c7d467d6db3a3a543fa5b42fe53dc</mark></code></pre>
</div>
</div>
<div class="paragraph">
<p>A successful pipeline should have pushed the image to the external container registry. The following screen shot shows the image pushed to <strong>rhdevelopers</strong> Quay.io container registry repo:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/pushed_image.png" alt="pushed image">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you noticed the highlighted <strong>sha256</strong> from the log above, is same as that of the <strong>sha256</strong> listed in the contianer registry repository.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tekton-remote-ref-points"><a class="anchor" href="#tekton-remote-ref-points"></a>Points to Ponder</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When need to pull from remote source repository or push to external container registry:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Kubernetes Secret to hold the container registry credentials</p>
</li>
<li>
<p>A Kubenretes Service Account, with the container registry Secret added to it</p>
</li>
<li>
<p>Use the Service Account as <code>serviceAccountName</code> in PipelineRuns/TaskRuns</p>
</li>
<li>
<p>Annotate Secerts to map which Secret to be used with source repository</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can find more details about using Authentication with Tekton <a href="https://tekton.dev/docs/pipelines/auth/">here</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tekton-auth-cleanup"><a class="anchor" href="#tekton-auth-cleanup"></a>Cleanup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you no longer going to use the workspace-auth-demo, you can do:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete ns workspace-auth-demo</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="workspaces.html">Workspaces</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
