<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Triggers :: Tekton Tutorial</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/tekton-tutorial/tekton-tutorial/triggers.html">
    <link rel="prev" href="private_reg_repos.html">
    <link rel="next" href="openshift/index.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-scholars.github.io/tekton-tutorial">Tekton Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="tekton-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="setup.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#tekton-prerequisites">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#download-tutorial-sources">Download Tutorial Sources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#kubernetes-cluster">Choose your Kubernetes Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#tutorial-dev-env">Development Environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#deploy-tekton">Install Tekton</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#install-tekton-cli">Install Tekton CLI</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="pipeline-resources.html">Pipeline Resources</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipeline-resources.html#tekton-res-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipeline-resources.html#tekton-res-create">Create Pipeline Resource</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipeline-resources.html#tekton-res-deploy">Deploy Pipeline Resource</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipeline-resources.html#tkn-see-what-you-have-deployed">See what you have deployed</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="tasks.html">Tasks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="tasks.html#tekton-tasks]">Tasks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tasks.html#tekton-task-clone">Clone Source Code</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-task-list-ws">Know your Workspace</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-task-clustertask">Cluster Task</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-tasks-points-to-ponder">Points to Ponder</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="tasks.html#tekton-task-build-sources">Build Cloud Native Application</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tasks.html#build-sources">Build Sources</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tasks.html#build-linux-image">Build Image</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tasks.html#push-linux-image">Push Image</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-task-deploy">Deploy Task</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-task-run">TaskRun</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-test-task-output">Test Task Output</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-task-step-template">Step Template</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-task-cleanup">Clean</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="pipelines.html">Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipelines.html#tekton-add-tasks">Add Tasks from Catalog</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipelines.html#tekton-pipeline-create">Create Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipelines.html#tekton-pipeline-deploy">Deploy Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipelines.html#tekton-pipeline-run">Run Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipelines.html#tekton-test-pipeline">Test Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipelines.html#tekton-pipeline-cleanup">Clean</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="workspaces.html">Workspaces</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="workspaces.html#ws-overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="workspaces.html#ws-prepare">Prepare for Using Workspaces</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-tasks-deploy">Deploy Tasks from Catalog</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-deploy-nexus">Deploy Nexus</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-create-maven-settings-cm">Create Maven Settings</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-deploy-knative">Deploy Knative</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-check-sc">Check Default Storage Class</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="workspaces.html#ws-pipeline-overview">Java Application Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="workspaces.html#ws-use-pvc">Using Persistent Volumes as Workspace</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-use-pvc-git-clone">Git Clone TaskRun</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-pvc-points-to-ponder">Points to Ponder</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="workspaces.html#ws-use-cm">Using ConfigMap as Workspace</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-use-cm-mvn-run">Run maven Task</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#use-cm-points-to-ponder">Points to Ponder</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="workspaces.html#ws-deploy-pipeline">Deploy Pipeline</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-create-pipeline">Create Pipeline</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-run-pipeline">Run Pipeline</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workspaces.html#ws-verify-service">Verify Deployed Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="workspaces.html#tekton-ws-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="private_reg_repos.html">Private Registries and Repositories</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="private_reg_repos.html#tkn-prr-overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="private_reg_repos.html#tekton-pull-from-remote-repo">Pulling from Private Source Repository</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="private_reg_repos.html#tekton-github-repo-secret">Create Github PAT Secret</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="private_reg_repos.html#tekton-github-sa">Create Service Account</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="private_reg_repos.html#tekton-create-clone-pipeline">Create And Run Pipeline</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="private_reg_repos.html#tekton-push-to-external-reg">Pushing To External Registry</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="private_reg_repos.html#tekton-push-registry-secret">Create Registry Secret</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="private_reg_repos.html#tekton-build-sa">Create Service Account</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="private_reg_repos.html#tekton-create-build-push-pipeline">Create And Run Pipeline</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="private_reg_repos.html#tekton-remote-ref-points">Points to Ponder</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="private_reg_repos.html#tekton-auth-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="triggers.html">Triggers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#install-tekton-triggers">Instal Tekton Triggers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tkn-triggers-prepare">Prepare Namespace</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tkn-triggers-init-repo">Initialize Source Repository</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tkn-triggers-create-sa"> Pipeline Service Account</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tkn-triggers-template">Trigger Template</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tkn-triggers-bindings">Trigger Bindings</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tkn-triggers-eventlistener">Trigger Event Listener</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tekton-triggers-in-action">Triggers in Action</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tekton-triggers-ptp">Points to Ponder</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="openshift/index.html">OpenShift Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="openshift/setup.html">Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="openshift/openshift_pipelines.html">Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="openshift/openshift_pipelines.html#ocp-create-project">Create Project</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="openshift/openshift_pipelines.html#openshift-pipelines-prep-app-deploy">Prepare Application Deployment</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="openshift/openshift_pipelines.html#required-tasks">Required Cluster Tasks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="openshift/openshift_pipelines.html#ocp-update-cluster-tasks">Update Cluster Tasks</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="openshift/openshift_pipelines.html#ocp-deploy-app-from-git">Deploy Application from GitHub</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="openshift/openshift_pipelines.html#ocp-create-java-ksvc-pipeline-tpl">Pipeline Template for Java and Knative Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="openshift/openshift_pipelines.html#odc-create-ksvc-java-app">Deploy Application with Pipeline</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="openshift/openshift_pipelines.html#odc-view-pipelines">View Pipelines</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="openshift/openshift_pipelines.html#odc-watch-pipelines">Watch Pipelines</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="openshift/openshift_pipelines.html#odc-view-app">Application Topology</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="openshift/openshift_pipelines.html#odc-pipeline-points">Points to Ponder</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Tekton Tutorial</a></li>
    <li><a href="triggers.html">Triggers</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/tekton-tutorial/blob/v0.14.3/documentation/modules/ROOT/pages/triggers.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Triggers</h1>
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This chapter build is in progress, expect to change and not working as expected
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At the end of this chapter you will be able to :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What are Tekton Triggers</p>
</li>
<li>
<p>How to Trigger a Pipeline or Task based on Events</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tkn-triggers-overview"><a class="anchor" href="#tkn-triggers-overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Until now we have seen how to create Tasks and Pipelines. But whenever it comes to running the Tasks and Pipelines we always relied on doing it manually. In the Chapter we will be expoloring how to do it using Triggers, e.g. say you push a commit in to the source repository and it triggers a PipelineRun to deploy a new application or a TaskRun to push the image to container registry. Lets rock!</p>
</div>
<div class="paragraph">
<p>If you are not in tutorial chapter folder, then navigate to the folder:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd $TUTORIAL_HOME/triggers</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="install-tekton-triggers"><a class="anchor" href="#install-tekton-triggers"></a>Install Triggers</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In OpenShfit, the OpenShift pipelines operator installs Tekton Pipelines and Tekton Triggers in openshift-pipelines namespace. Its not needed install Tekton Triggers.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f <a href="https://storage.googleapis.com/tekton-releases/triggers/previous/v0.10.2/release.yaml" class="bare">https://storage.googleapis.com/tekton-releases/triggers/previous/v0.10.2/release.yaml</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for the Tekton Trigger controller and webhook to be ready:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch kubectl -n tekton-pipelines get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>A successful Tekton run should have the highlighted Tekton Trigger pods running in the <code>tekton-pipelines</code>:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                           READY   STATUS    RESTARTS   AGE
tekton-pipelines-controller-849ccccd7f-gc6dp   1/1     Running   1          3d3h
tekton-pipelines-webhook-75bc7666c-9crwq       1/1     Running   1          3d3h
<mark>tekton-triggers-controller-697c9b844d-9lz4x    1/1     Running   0          15h</mark>
<mark>tekton-triggers-webhook-6bcb96f965-gqrbh       1/1     Running   0          15h</mark></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tkn-triggers-prepare"><a class="anchor" href="#tkn-triggers-prepare"></a>Prepare namespace</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All exercises of this chapter will be done a namesapace <code>triggers-demo</code>, lets create and switch to the <code>triggers-demo</code> namespace.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create ns triggers-demo
kubectl config set-context --current --namespace triggers-demo</code></pre>
</div>
</div>
<div class="paragraph">
<p>As part of this exercise we will need to install the following external tasks to be installed in the namespace:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/tektoncd/catalog/tree/master/task/git-clone/0.1">git-clone</a></p>
</li>
<li>
<p><a href="https://github.com/tektoncd/catalog/tree/master/task/maven/0.1">maven</a></p>
</li>
<li>
<p><a href="https://github.com/tektoncd/catalog/tree/master/task/buildah/0.1">buildah</a></p>
</li>
<li>
<p><a href="https://github.com/tektoncd/catalog/tree/master/task/kn/0.1">knative client(kn)</a></p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n triggers-demo \
  -f <a href="https://raw.githubusercontent.com/tektoncd/catalog/master/task/git-clone/0.1/git-clone.yaml" class="bare">https://raw.githubusercontent.com/tektoncd/catalog/master/task/git-clone/0.1/git-clone.yaml</a> \
  -f <a href="https://raw.githubusercontent.com/tektoncd/catalog/master/task/maven/0.1/maven.yaml" class="bare">https://raw.githubusercontent.com/tektoncd/catalog/master/task/maven/0.1/maven.yaml</a> \
  -f <a href="https://raw.githubusercontent.com/tektoncd/catalog/master/task/buildah/0.1/buildah.yaml" class="bare">https://raw.githubusercontent.com/tektoncd/catalog/master/task/buildah/0.1/buildah.yaml</a> \
  -f <a href="https://raw.githubusercontent.com/tektoncd/catalog/master/task/kn/0.1/kn.yaml" class="bare">https://raw.githubusercontent.com/tektoncd/catalog/master/task/kn/0.1/kn.yaml</a> \
  -f <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/workspaces/list-directory-task.yaml">$TUTORIAL_HOME/workspaces/list-directory-task.yaml</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>Check if all the tasks are available:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn task ls</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command should show an output like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME               DESCRIPTION              AGE
buildah            Buildah task builds...   11 hours ago
git-clone          These Tasks are Git...   11 hours ago
kn                 This Task performs ...   9 minutes ago
list-directory     Simple directory li...   11 hours ago
maven              This Task can be us...   11 hours ago</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="ws-deploy-nexus"><a class="anchor" href="#ws-deploy-nexus"></a>Deploy Nexus</h3>
<div class="paragraph">
<p>To show maven artifact caching and using customized maven <code>settings.xml</code> we will deploy Sonatype Nexus to the cluster:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n triggers-demo \
  -f <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/install/utils/nexus.yaml" target="_blank" rel="noopener">$TUTORIAL_HOME/install/utils/nexus.yaml</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for the nexus3 pod to come up before proceeding further with exercises:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch kubectl -n triggers-demo get pods,svc</code></pre>
</div>
</div>
<div class="paragraph">
<p>A sucessfully running nexus3 pod should show the following services and pods:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                         READY   STATUS    RESTARTS   AGE
pod/nexus-75fff8bbbd-cmlxs   1/1     Running   0          3m25s

NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
service/nexus        NodePort    10.100.205.22   &lt;none&gt;        8081:31743/TCP   3m25s</code></pre>
</div>
</div>
<div class="paragraph">
<p>The nexus maven repository could be opened using the url:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$(minikube service nexus -n triggers-demo)</code></pre>
</div>
</div>
<div class="admonitionblock note optional">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="OPTIONAL"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In OpenShift,we can use routes to expose the service if we need to access it from outside,by:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl expose svc -n triggers-demo nexus</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ws-create-maven-settings-cm"><a class="anchor" href="#ws-create-maven-settings-cm"></a>Create maven-settings ConfigMap</h3>
<div class="paragraph">
<p>For us to mount the maven <code>settings.xml</code>, we will create ConfigMap holding the custom maven settings.xml:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create -n triggers-demo cm maven-settings \
  --from-file=settings.xml=<a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/workspaces/maven-settings.xml" target="_blank" rel="noopener">$TUTORIAL_HOME/workspaces/maven-settings.xml</a></code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">configmap/maven-settings created</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can check the ConfigMap contents using the command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get -n triggers-demo cm maven-settings -oyaml \
  | yq r - data['settings.xml']</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of the above command should be same as in <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/workspaces/maven-settings.xml" target="_blank" rel="noopener">maven-settings.xml</a>.</p>
</div>
<div class="paragraph">
<p>Before we create our pipeline ensure that the kubernetes cluster has a default storage class defined:</p>
</div>
</div>
<div class="sect2">
<h3 id="ws-deploy-knative"><a class="anchor" href="#ws-deploy-knative"></a>Deploy Knative Serving</h3>
<div class="paragraph">
<p>As we will be deploying a <a href="https://knative.dev">Knative</a> serverless application as part of the pipeline, that we will be running later in this chapter, lets deploy Knative to the cluster:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset1_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_minikube">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Do it only once per cluster
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$TUTORIAL_HOME/bin/<a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/bin/enable_knative.sh" target="_blank" rel="noopener">enable_knative.sh</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for the serving deployment to complete without errors.</p>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_openshift">
<div class="paragraph">
<p>OpenShift users can install Knative i.e <a href="https://docs.openshift.com/container-platform/4.1/serverless/installing-openshift-serverless.html">OpenShift Serverless</a> using its Operators.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ws-check-sc"><a class="anchor" href="#ws-check-sc"></a>Check Default Storage Class</h3>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get sc</code></pre>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_kubernetes"></a>Kubernetes</p>
</li>
<li>
<p><a id="tabset2_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_kubernetes">
<div class="paragraph">
<p>In minkube cluster it should show an output like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code>NAME                 PROVISIONER                RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
standard (<mark>default</mark>)   k8s.io/minikube-hostpath   Delete          Immediate           false                  9h</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_openshift">
<div class="paragraph">
<p>An example default storage class in Google Cloud:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                 PROVISIONER            RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
standard (default)   kubernetes.io/gce-pd   Delete          WaitForFirstConsumer   true                   2d3h</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>If you dont have one please check <a href="https://kubernetes.io/docs/concepts/storage/storage-classes/">Kubernetes Docs</a> on how to have one configured.</p>
</li>
<li>
<p>In OpenShift cluster the default storage class varies based on the underlying cloud platform. Refer to <a href="https://docs.openshift.com/container-platform/4.5/storage/dynamic-provisioning.html">OpenShift Documentation</a> to know more.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_create_pvc"><a class="anchor" href="#_create_pvc"></a>Create PVC</h3>
<div class="paragraph">
<p>Create the PVC <code>tekton-tutorial-sources</code>, which we will use as part of the exercises in this chapter and the upcoming ones.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n triggers-demo -f <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/workspaces/sources-pvc.yaml" target="_blank" rel="noopener">$TUTORIAL_HOME/workspaces/sources-pvc.yaml</a></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tkn-triggers-create-pipeline"><a class="anchor" href="#tkn-triggers-create-pipeline"></a>Create Pipeline</h3>
<div class="paragraph">
<p>As part of the Trigger exercise we will be runing the greeter-app-deploy pipeline, lets deploy the pipeline to be used later:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n triggers-demo \
  -f <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/workspaces/greeter-app-deploy.yaml" target="_blank" rel="noopener">$TUTORIAL_HOME/workspaces/greeter-app-deploy.yaml</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify the available pipelines:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn pipeline -n triggers-demo ls</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                    AGE            LAST RUN   STARTED   DURATION   STATUS
greeter-app-deploy   1 minute ago   ---        ---       ---        ---</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_gogs"><a class="anchor" href="#_deploy_gogs"></a>Deploy Gogs</h3>
<div class="paragraph">
<p>Since we need to trigger a Pipeline with a git push, we will deploy a Git server to the local cluster. This will avoid us the need to expose the service to the public internet and also helps us to test things quickly with our local cluster setup.</p>
</div>
<div class="paragraph">
<p><a href="https://gogs.io/">Gogs</a> is super quick and easy to install i.e. self-hosted git service. Lets deploy that into the Kubernetes Cluster.</p>
</div>
</div>
<div class="sect2">
<h3 id="_create_gogs_ingress"><a class="anchor" href="#_create_gogs_ingress"></a>Create Gogs Ingress</h3>
<div class="paragraph">
<p>Create the gogs ingress so that we can access the application from host machine using http:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export GOGS_HOSTNAME="gogs.$(minikube ip).nip.io"</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">yq w <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/install/git/gogs-ingress.yaml">$TUTORIAL_HOME/install/git/gogs-ingress.yaml</a> \
  spec.virtualhost.fqdn $GOGS_HOSTNAME |\
  kubectl apply -n triggers-demo -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create gogs config file <code>app.ini</code> from the template and add that to gogs ConfigMap:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sed "s/@GOGS_HOSTNAME@/$GOGS_HOSTNAME/g" <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/install/git/app.ini.template">$TUTORIAL_HOME/install/git/app.ini.template</a> \
  | tee $TUTORIAL_HOME/install/git/app.ini</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n triggers-demo \
  -k <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/install/git">$TUTORIAL_HOME/install/git/</a></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We use <a href="https://kubernetes-sigs.github.io/kustomize/">kustomize</a> that allows us to do some customizations on the Kubenetes manifests before we apply them. Kustomize is built into kubectl and can be used with <code>-k</code> option.
</td>
</tr>
</table>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">configmap/gogs-config created
service/gogs-postgresql created
service/gogs created
deployment.apps/gogs-postgresql created
deployment.apps/gogs created
persistentvolumeclaim/gogs-data created
persistentvolumeclaim/pgdata-pvc created
persistentvolumeclaim/pgwal-pvc created</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for the <code>gogs-postgresql</code> and <code>gogs</code> pods to come up, watch the status using :</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch kubectl get pods,svc -lapp=gogs</code></pre>
</div>
</div>
<div class="paragraph">
<p>A suceesfull deployment should show:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                  READY   STATUS    RESTARTS   AGE
pod/gogs-854766b6d7-nsmsp             1/1     Running   0          64s
pod/gogs-postgresql-745dfd5cb-spc46   1/1     Running   0          64s

NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
service/gogs              NodePort    10.106.116.15    &lt;none&gt;        3000:31550/TCP   64s
service/gogs-postgresql   ClusterIP   10.105.150.118   &lt;none&gt;        5432/TCP         64s</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can access the gogs service using ingress url:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">open <a href="http://$GOGS_HOSTNAME" class="bare">http://$GOGS_HOSTNAME</a></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/gogs_home.png" alt="gogs home">
</div>
<div class="title">Figure 1. Gogs Home</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tkn-create-sa"><a class="anchor" href="#tkn-create-sa"></a>Create ServiceAccount, Roles and Role Bindins</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We need to query Kubernetes objects, create Triggers and finally deploy the Knative Service as part of this chapter' exercies. Lets create a Kubernetes Service Account and add the required roles/permissions:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -k <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/triggers/rbac">$TUTORIAL_HOME/triggers/rbac</a></code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">serviceaccount/pipeline created
role.rbac.authorization.k8s.io/app-deployer-role created
role.rbac.authorization.k8s.io/tekton-triggers-admin created
role.rbac.authorization.k8s.io/tekton-triggers-createwebhook created
rolebinding.rbac.authorization.k8s.io/app-deployer-binding created
rolebinding.rbac.authorization.k8s.io/tekton-triggers-admin-binding created
rolebinding.rbac.authorization.k8s.io/tekton-triggers-createwebhook-binding created</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In OpenShift you might no need the <strong>pipeline</strong> SA, as the OpenShift Pipelines creates it by default
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tkn-triggers-init-repo"><a class="anchor" href="#tkn-triggers-init-repo"></a>Initialize Source Repository</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To run the exercises of this chapter we need the following setup in Git(gogs):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Git user, for the demo we will create user called <strong>gogs</strong> with password <strong>gogs</strong></p>
</li>
<li>
<p>A Git Repository named <code>tekton-greeter</code>, we will use <a href="https://github.com/redhat-scholars/tekton-tutorial-greeter" class="bare">https://github.com/redhat-scholars/tekton-tutorial-greeter</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We will run the following Task to perform the necessary intializations listed above:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create -n triggers-demo \
  -f <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/triggers/gogs-init-taskrun.yaml" target="_blank" rel="noopener">gogs-init-taskrun.yaml</a></code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">taskrun.tekton.dev/init-gogs-qkf84 created</code></pre>
</div>
</div>
<div class="paragraph">
<p>View the task run  logs using,</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn tr logs -f -a $(tkn tr ls -n triggers-demo | awk 'NR==2{print $1}')</code></pre>
</div>
</div>
<div class="paragraph">
<p>A successfull initializations should show an output like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[init-gogs] Created admin user gogs:gogs
[init-gogs] Created git repo tekton-tutorial-greeter
[init-gogs] Repository Clone url http://gogs.192.168.64.5.nip.io/gogs/https://github.com/redhat-scholars/tekton-tutorial-greeter.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should now be able to open the <strong>Repository Clone url</strong> from the output above and view the respository content.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tkn-triggers-template"><a class="anchor" href="#tkn-triggers-template"></a>Trigger Template</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TriggerTemplate is responsible to create the Tekton Resources when it receives the Event from the EventListener.</p>
</div>
<div class="sect2">
<h3 id="tkn-triggers-create-template"><a class="anchor" href="#tkn-triggers-create-template"></a>Create Trigger Template</h3>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create -n triggers-demo \
  -f <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/triggers/greeter-trigger-template.yaml" target="_blank" rel="noopener">greeter-trigger-template.yaml</a></code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">triggertemplate.triggers.tekton.dev/tekton-greeter-trigger-template created</code></pre>
</div>
</div>
<div class="paragraph">
<p>List the available TriggerTemplates:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn tt -n triggers-demo ls</code></pre>
</div>
</div>
<div class="paragraph">
<p>It should be only one now:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                 AGE
tekton-greeter-trigger-template   1 minute ago</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tkn-triggers-bindings"><a class="anchor" href="#tkn-triggers-bindings"></a>Trigger Bindings</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TriggerBinding is responsible to bind the Event payload with Template Parameters. In this case it will bind the gogs event playload to TriggerTemplate parameters, inputs, outputs and workspaces.</p>
</div>
<div class="paragraph">
<p>Let us see a sample webhook payload that Git events from Gogs might look like:</p>
</div>
<div class="listingblock">
<div class="title">Gogs Payload sample</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "ref": "refs/heads/master",
  "before": "d84fc84f8d7a1da0b49140f644613168e4af3110",
  <mark>"after": "becd943814ef904215c0c6f301434ce8faf31c26",</mark>
  "compare_url": "http://gogs.192.168.64.5.nip.io/gogs/tekton-greeter/compare/d84fc84f8d7a1da0b49140f644613168e4af3110...becd943814ef904215c0c6f301434ce8faf31c26",
  "commits": [
    {
      "id": "becd943814ef904215c0c6f301434ce8faf31c26",
      "message": "First Test Trigger\n",
      "url": "http://gogs.192.168.64.5.nip.io/gogs/tekton-greeter/commit/becd943814ef904215c0c6f301434ce8faf31c26",
      "author": {
        "name": "Kamesh Sampath",
        "email": "kamesh.sampath@hotmail.com",
        "username": ""
      },
      "committer": {
        "name": "Kamesh Sampath",
        "email": "kamesh.sampath@hotmail.com",
        "username": ""
      },
      "added": [],
      "removed": [],
      "modified": [
        "src/main/java/com/redhat/developers/GreetingResource.java"
      ],
      "timestamp": "2020-07-29T05:24:44Z"
    }
  ],
  "repository": {
    "id": 5,
    "owner": {
      "id": 1,
      "login": "gogs",
      "full_name": "",
      "email": "admin@gogs.com",
      "avatar_url": "https://secure.gravatar.com/avatar/4d667b96bad9b51aafc728a20ebce918",
      "username": "gogs"
    },
    "name": "tekton-greeter",
    "full_name": "gogs/tekton-greeter",
    "description": "",
    "private": false,
    "fork": false,
    "parent": null,
    "empty": false,
    "mirror": false,
    "size": 323584,
    "html_url": "http://gogs.192.168.64.5.nip.io/gogs/tekton-greeter",
    "ssh_url": "gogs@gogs.192.168.64.5.nip.io:gogs/tekton-greeter.git",
    <mark>"clone_url": "http://gogs.192.168.64.5.nip.io/gogs/tekton-greeter.git",</mark>
    "website": "",
    "stars_count": 0,
    "forks_count": 0,
    "watchers_count": 1,
    "open_issues_count": 0,
    "default_branch": "master",
    "created_at": "2020-07-28T15:22:20Z",
    "updated_at": "2020-07-28T15:22:24Z"
  },
  "pusher": {
    "id": 1,
    "login": "gogs",
    "full_name": "",
    "email": "admin@gogs.com",
    "avatar_url": "https://secure.gravatar.com/avatar/4d667b96bad9b51aafc728a20ebce918",
    "username": "gogs"
  },
  "sender": {
    "id": 1,
    "login": "gogs",
    "full_name": "",
    "email": "admin@gogs.com",
    "avatar_url": "https://secure.gravatar.com/avatar/4d667b96bad9b51aafc728a20ebce918",
    "username": "gogs"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use any attribute/data from the JSON payload and bind them as the value in TriggerBindings. For this chapter exercise we are interested in two attributes namely:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>after</strong>: the commit hash after our push is merged into the master</p>
</li>
<li>
<p><strong>repository.clone_url</strong>: The Git Repo clone url</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The HTTP Body and Headers of the eventt payload are available as <code>body</code> and <code>header</code> JSONPath variables. We can retrieve the values using JSONPath expressions. Check the <a href="https://github.com/tektoncd/triggers/blob/master/docs/triggerbindings.md#event-variable-interpolation">Event Variable Interpolation</a> for more details.</p>
</div>
<div class="paragraph">
<p>To retreieve the <code>after</code> and <code>repository.clone_url</code> we will the JSONPath expressions <code>$(body.after)</code> and <code>$(body.repoistory.clone_url)</code> respectively.</p>
</div>
<div class="sect2">
<h3 id="tkn-triggers-create-bindings"><a class="anchor" href="#tkn-triggers-create-bindings"></a>Create Trigger Bindings</h3>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/triggers/gogs-triggerbindings.yaml" target="_blank" rel="noopener">gogs-triggerbindings.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
apiVersion: triggers.tekton.dev/v1alpha1
kind: TriggerBinding
metadata:
  name: gogs-triggerbinding
spec:
  params:
    - name: gitrevision
      value: <mark>$(body.after)</mark>
    - name: gitrepositoryurl
      value: <mark>$(body.repository.clone_url)</mark></code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create -n triggers-demo -f gogs-triggerbindings.yaml</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">triggerbinding.triggers.tekton.dev/gogs-triggerbinding created</code></pre>
</div>
</div>
<div class="paragraph">
<p>List the available TriggerBindings:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn tb -n triggers-demo ls</code></pre>
</div>
</div>
<div class="paragraph">
<p>It should show an output like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                  AGE
gogs-triggerbinding   7 seconds ago</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tkn-triggers-eventlistener"><a class="anchor" href="#tkn-triggers-eventlistener"></a>Event Listener</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Event Listener is primary interace for external sources to send events, that will trigger the creation of Tekton resources defined as part of the TriggerTemplate.</p>
</div>
<div class="sect2">
<h3 id="tkn-triggers-create-eventlistener"><a class="anchor" href="#tkn-triggers-create-eventlistener"></a>Create Event Listener</h3>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n triggers-demo -f <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/triggers/gogs-eventlistener.yaml">gogs-eventlistener.yaml</a></code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">eventlistener.triggers.tekton.dev/gogs-webhook created</code></pre>
</div>
</div>
<div class="paragraph">
<p>List the available EventListeners:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn el -n triggers-demo ls</code></pre>
</div>
</div>
<div class="paragraph">
<p>It should show an output like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME           AGE
gogs-webhook   4 seconds ago</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each EventListener will have a service named <code>el-&lt;EventListener Name&gt;</code> exposed automatically for sources to send events to Triggers.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get svc -n triggers-demo -leventlistener=gogs-webhook</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
<mark>el-gogs-webhook   ClusterIP   10.97.199.207    &lt;none&gt;        8080/TCP         51s</mark></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_event_listener_ingress"><a class="anchor" href="#_create_event_listener_ingress"></a>Create Event Listener Ingress</h3>
<div class="paragraph">
<p>If you need the EventListner service to be available outside of the cluster thereby you can use them as part of the webhook, the service <code>el-gogs-webhook</code> needs to be exposed via Ingress:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset3_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_minikube">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export EL_WEBHOOK_URL="$(kubectl get svc -n triggers-demo el-gogs-webhook -o yaml \
  | yq r - 'metadata.name').$(minikube ip).nip.io"
export EL_WEBHOOK_LISTENER_PORT="$(kubectl get svc -n triggers-demo el-gogs-webhook -o yaml \
  | yq r - 'spec.ports.(name==http-listener).port')"</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">yq w <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/triggers/eventlistener-ingress.yaml">eventlistener-ingress.yaml</a> \
  spec.virtualhost.fqdn $EL_WEBHOOK_URL \
  | yq w - 'spec.routes[0].services[0].name' el-gogs-webhook \
  | yq w - 'spec.routes[0].services[0].port' $EL_WEBHOOK_LISTENER_PORT \
  | kubectl apply -n triggers-demo -f  -</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">httpproxy.projectcontour.io/el-gogs-webhook-ingress</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lets verify if the ingress has been configured correctly:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get httpproxy -n triggers-demo el-gogs-webhook-ingress -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command should the following output (trimmed for brevity):</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">apiVersion: projectcontour.io/v1
kind: HTTPProxy
metadata:
  name: el-gogs-webhook-ingress
  namespace: triggers-demo
spec:
  routes:
  - services:
    - name: <mark>el-gogs-webhook</mark>
      port: <mark>8080</mark>
  virtualhost:
    fqdn: <mark>el-gogs-webhook.192.168.64.5.nip.io</mark></code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_openshift">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc expose svc -n triggers-demo el-gogs-webhook --targetPort=http-listener</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tkn-triggers-configure-webhook"><a class="anchor" href="#tkn-triggers-configure-webhook"></a>Configure Webhook</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For the GitHub Triggers to work, we need to have the <a href="https://gogs.io/docs/features/webhook">Webhook</a> configured for the Git Repository <code>tekton-greeter</code> to point to the <code>el-gogs-webhook-ingress</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create -n triggers-demo \
  -f <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/triggers/gogs-webhook-taskrun.yaml" target="_blank" rel="noopener">gogs-webhook-taskrun.yaml</a></code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">taskrun.tekton.dev/webhook-gogs-lwkjt created</code></pre>
</div>
</div>
<div class="paragraph">
<p>View the task run  logs using,</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn tr logs -f -a $(tkn tr ls -n triggers-demo | awk 'NR==2{print $1}')</code></pre>
</div>
</div>
<div class="paragraph">
<p>A successfull initializations should show an output like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[webhook-gogs] Configured webhook: http://el-gogs-webhook.192.168.64.5.nip.io</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you note now the <code>tekton-greeter</code> Git repository in Gogs is configured with the webhook to send Git events to EventListener.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/gogs_webhook_settings.png" alt="gogs webhook settings">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tekton-triggers-in-action"><a class="anchor" href="#tekton-triggers-in-action"></a>Triggers in Action</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_terminal_1"><a class="anchor" href="#_terminal_1"></a>Terminal 1</h3>
<div class="paragraph">
<p>As we expect the triggers to start a Pipeline, lets open a new terminal and watch the running Pipelines:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch tkn pr -n triggers-demo ls</code></pre>
</div>
</div>
<div class="paragraph">
<p>You <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>c</kbd></span> the watch once you see it running and monitor the logs.</p>
</div>
</div>
<div class="sect2">
<h3 id="_terminal_2"><a class="anchor" href="#_terminal_2"></a>Terminal 2</h3>
<div class="paragraph">
<p>Open a new terminal and watch the logs the event listener to see the incoming events:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">stern -n triggers-demo gogs-webhook</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the event playload is received from the gogs, you should see output(trimmed for brevity) as shown below:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">...
el-gogs-webhook-88bc89db-ld6jz event-listener {"level":"info","logger":"eventlistener","caller":"resources/create.go:93","msg":"Generating resource: kind: &amp;APIResource{Name:pipelineruns,Namespaced:true,Kind:PipelineRun,Verbs:[delete deletecollection get list patch create update watch],ShortNames:[pr prs],SingularName:pipelinerun,Categories:[tekton tekton-pipelines],Group:tekton.dev,Version:v1beta1,StorageVersionHash:4xDTCrDXyFg=,}, name: greeter-app-","knative.dev/controller":"eventlistener"}
el-gogs-webhook-88bc89db-ld6jz event-listener {"level":"info","logger":"eventlistener","caller":"resources/create.go:101","msg":"For event ID \"rrgcn\" creating resource tekton.dev/v1beta1, Resource=pipelineruns","knative.dev/controller":"eventlistener"}
...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_clone_and_edit_the_source"><a class="anchor" href="#_clone_and_edit_the_source"></a>Clone and Edit the source</h3>
<div class="paragraph">
<p>Using your favorite IDE clone the repo <code>tekton-greeter</code> from Gogs using the <a href="#tkn-triggers-init-repo">clone url</a>.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">git clone &lt;your gogs tekton-greeter clone url&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open the <code>tekton-tutorial-greeter</code> in your IDE and edit the Java file:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset4_quarkus"></a>Quarkus</p>
</li>
<li>
<p><a id="tabset4_springboot"></a>SpringBoot</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset4_quarkus">
<div class="ulist">
<ul>
<li>
<p><code>src/main/java/com/redhat/developers/GreetingResource.java</code> to update the "Meeow!! from Tekton " to " Tekton Rocks!"</p>
</li>
<li>
<p><code>src/test/java/com/redhat/developers/GreetingResourceTest.java</code> to match " Tekton Rocks!".</p>
</li>
</ul>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset4_springboot">
<div class="ulist">
<ul>
<li>
<p><code>src/main/java/com/redhat/developer/demos/GreetingController.java</code> to update the "Meeow!! from Tekton " to " Tekton Rocks!"</p>
</li>
<li>
<p><code>src/test/java/com/redhat/developer/demos/GreetingControllerTest.java</code> to match " Tekton Rocks!".</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Commit and push to see the  Pipeline <code>greeter-app-deploy</code> running .</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Use the username <code>gogs</code> and password <code>gogs</code> when prompted during Git push to repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>View the pipeline run logs using,</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn pr logs -f -a $(tkn pr ls -n triggers-demo | awk 'NR==2{print $1}')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the Pipeline succeeds, verify the Knative Service <code>greeter</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">http --body (kn service describe greeter -o url)/hello</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command should shown output like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"> Tekton Rocks!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Expriment with updating the sources to your taste and see the pipeline triggers.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tekton-triggers-ptp"><a class="anchor" href="#tekton-triggers-ptp"></a>Points to Ponder</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To use Tekton Triggers we need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Kubernetes Service Account with required premissions assigned</p>
</li>
<li>
<p>A TriggerTemplate which defines what Tekton Resources to create for a events</p>
</li>
<li>
<p>A TriggerBinding which allows to extract the data from the event payload and bind them to Tekton Parameters of Task/Pipeline</p>
</li>
<li>
<p>A EventListener that will listen for the  events and trigger the executuion of Tekton Resources as part of the Trigger Template</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tkn-triggers-cleanup"><a class="anchor" href="#tkn-triggers-cleanup"></a>Cleanup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you no longer going to use the triggers-demo, you can do:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete ns triggers-demo</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="private_reg_repos.html">Private Registries and Repositories</a></span>
  <span class="next"><a href="openshift/index.html">OpenShift Pipelines</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
