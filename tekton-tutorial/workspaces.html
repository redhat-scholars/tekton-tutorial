<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Workspaces :: Tekton Tutorial</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/tekton-tutorial/tekton-tutorial/workspaces.html">
    <link rel="prev" href="pipelines.html">
    <link rel="next" href="private_reg_repos.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-scholars.github.io/tekton-tutorial">Tekton Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="tekton-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="setup.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#tekton-prerequisites">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#download-tutorial-sources">Download Tutorial Sources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#kubernetes-cluster">Choose your Kubernetes Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#deploy-tekton">Install Tekton</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#install-tekton-cli">Install Tekton CLI</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="tasks.html">Tasks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="tasks.html#tekton-tasks]">Tasks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tasks.html#tekton-task-clone">Clone Source Code</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-task-list-ws">Know your Workspace</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-task-clustertask">Cluster Task</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-tasks-points-to-ponder">Points to Ponder</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="tasks.html#tekton-task-build-sources">Build Cloud Native Application</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tasks.html#build-sources">Build Sources</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tasks.html#build-linux-image">Build Image</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tasks.html#push-linux-image">Push Image</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-task-deploy">Deploy Task</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-task-run">TaskRun</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-test-task-output">Test Task Output</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-task-step-template">Step Template</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html#tekton-task-cleanup">Clean</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="pipelines.html">Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipelines.html#tekton-add-tasks">Add Tasks from Catalog</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipelines.html#tekton-pipeline-create">Create Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipelines.html#tekton-pipeline-deploy">Deploy Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipelines.html#tekton-pipeline-run">Run Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipelines.html#tekton-test-pipeline">Test Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipelines.html#tekton-pipeline-cleanup">Clean</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="workspaces.html">Workspaces</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#ws-overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#ws-prepare">Prepare for Using Workspaces</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#ws-tasks-deploy">Deploy Tasks from Catalog</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#ws-deploy-nexus">Deploy Nexus</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#ws-create-maven-settings-cm">Create Maven Settings</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#ws-deploy-knative">Deploy Knative</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#ws-check-sc">Check Default Storage Class</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#ws-pipeline-overview">Java Application Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#ws-use-pvc">Using Persistent Volumes as Workspace</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#ws-use-pvc-git-clone">Git Clone TaskRun</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#ws-pvc-points-to-ponder">Points to Ponder</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#ws-use-cm">Using ConfigMap as Workspace</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#ws-use-cm-mvn-run">Run maven Task</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#use-cm-points-to-ponder">Points to Ponder</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#ws-deploy-pipeline">Deploy Pipeline</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#ws-create-pipeline">Create Pipeline</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#ws-run-pipeline">Run Pipeline</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#ws-verify-service">Verify Deployed Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tekton-ws-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="private_reg_repos.html">Private Registries and Repositories</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="private_reg_repos.html#tkn-prr-overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="private_reg_repos.html#tekton-pull-from-remote-repo">Pulling from Private Source Repository</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="private_reg_repos.html#tekton-github-repo-secret">Create Github PAT Secret</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="private_reg_repos.html#tekton-github-sa">Create Service Account</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="private_reg_repos.html#tekton-create-clone-pipeline">Create And Run Pipeline</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="private_reg_repos.html#tekton-push-to-external-reg">Pushing To External Registry</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="private_reg_repos.html#tekton-push-registry-secret">Create Registry Secret</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="private_reg_repos.html#tekton-build-sa">Create Service Account</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="private_reg_repos.html#tekton-create-build-push-pipeline">Create And Run Pipeline</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="private_reg_repos.html#tekton-remote-ref-points">Points to Ponder</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="private_reg_repos.html#tekton-auth-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="triggers.html">Triggers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="triggers.html#tkn-triggers-prepare">Prepare Namespace</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="triggers.html#tkn-create-sa"> Pipeline Service Account</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="triggers.html#tkn-triggers-init-repo">Initialize Source Repository</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="triggers.html#install-tekton-triggers">Install Tekton Triggers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="triggers.html#tkn-triggers-template">Trigger Template</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="triggers.html#tkn-triggers-bindings">Trigger Bindings</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="triggers.html#tkn-triggers-eventlistener">Trigger Event Listener</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="triggers.html#tekton-triggers-in-action">Triggers in Action</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="triggers.html#tekton-triggers-ptp">Points to Ponder</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="openshift/index.html">OpenShift Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="openshift/setup.html">Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="openshift/openshift_pipelines.html">Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="openshift/openshift_pipelines.html#ocp-create-project">Create Project</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="openshift/openshift_pipelines.html#openshift-pipelines-prep-app-deploy">Prepare Application Deployment</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="openshift/openshift_pipelines.html#required-tasks">Required Cluster Tasks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="openshift/openshift_pipelines.html#ocp-update-cluster-tasks">Update Cluster Tasks</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="openshift/openshift_pipelines.html#ocp-deploy-app-from-git">Deploy Application from GitHub</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="openshift/openshift_pipelines.html#ocp-create-java-ksvc-pipeline-tpl">Pipeline Template for Java and Knative Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="openshift/openshift_pipelines.html#odc-create-ksvc-java-app">Deploy Application with Pipeline</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="openshift/openshift_pipelines.html#odc-view-pipelines">View Pipelines</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="openshift/openshift_pipelines.html#odc-watch-pipelines">Watch Pipelines</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="openshift/openshift_pipelines.html#odc-view-app">Application Topology</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="openshift/openshift_pipelines.html#odc-pipeline-points">Points to Ponder</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Tekton Tutorial</a></li>
    <li><a href="workspaces.html">Workspaces</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/tekton-tutorial/edit/master/documentation/modules/ROOT/pages/workspaces.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Workspaces</h1>
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Currently, there is an incompatibility between Tekton pipelines webhook and Minikube. Please expect no logs when running tkn commands .
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At the end of this chapter you will be able to :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand what is a <a href="https://github.com/tektoncd/pipeline/blob/master/docs/workspaces.md">Workspaces</a> ?</p>
</li>
<li>
<p>Mount ConfigMap based configurations as Workspace</p>
</li>
<li>
<p>Mount a PersistenceVolume as Workspace</p>
</li>
<li>
<p>Share and Cache build artifacts</p>
</li>
<li>
<p>Use workspace in TaskRun</p>
</li>
<li>
<p>Use workspace in PipelineRun</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you are not in tutorial chapter folder, then navigate to the folder:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd $TUTORIAL_HOME/workspaces</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_workspace"><a class="anchor" href="#_why_workspace"></a>Why Workspace ?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In many partical usecases of Pipelines it becomes crucial for you to share the filesystem between Tasks and between Steps. The filesystem could typically hold a clone github repostiory, a ConfigMap or a secret.</p>
</div>
<div class="paragraph">
<p>A Task step and Pipeline task can share a common filesystem via a Tekton <code>workspace</code>. This helps Pipelines to pick up changes from one task to another task in the Pipeline workflow.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ws-overview"><a class="anchor" href="#ws-overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As part of <code>workspaces</code> exercies, we will be building the Java application <a href="https://maven.apache.org">Apache Maven</a>. Using Java Application usecase allows us to explore all possible applications of workspaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mount ConfigMap based configurations as Workspace</p>
</li>
<li>
<p>Mount a PersistenceVolume as Workspace</p>
</li>
<li>
<p>Share and Cache build artifacts</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ws-prepare"><a class="anchor" href="#ws-prepare"></a>Prepare for using workspaces</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All exercises of this chapter will be done a namespace <code>workspace-auth-demo</code>, let&#8217;s create and switch to the <code>workspace-auth-demo</code> namespace.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create ns workspace-auth-demo
kubectl config set-context --current --namespace workspace-auth-demo</code></pre>
</div>
</div>
<div class="paragraph">
<p>As part of this exercise we will need to install the following external tasks and cluster tasks to be installed in the namespace:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/tektoncd/catalog/tree/master/task/git-clone/0.1">git-clone</a></p>
</li>
<li>
<p><a href="https://github.com/tektoncd/catalog/tree/master/task/maven/0.1">maven</a></p>
</li>
<li>
<p><a href="https://raw.githubusercontent.com/openshift/tektoncd-pipeline-operator/master/deploy/resources/addons/02-clustertasks/buildah/buildah-task.yaml">buildah</a></p>
</li>
<li>
<p><a href="https://github.com/tektoncd/catalog/tree/master/task/kn/0.1">knative client(kn)</a></p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n workspace-auth-demo \
  -f <a href="https://raw.githubusercontent.com/tektoncd/catalog/master/task/git-clone/0.1/git-clone.yaml" class="bare">https://raw.githubusercontent.com/tektoncd/catalog/master/task/git-clone/0.1/git-clone.yaml</a> \
  -f <a href="https://raw.githubusercontent.com/tektoncd/catalog/master/task/maven/0.1/maven.yaml" class="bare">https://raw.githubusercontent.com/tektoncd/catalog/master/task/maven/0.1/maven.yaml</a> \
  -f <a href="https://raw.githubusercontent.com/openshift/tektoncd-pipeline-operator/master/deploy/resources/addons/02-clustertasks/buildah/buildah-task.yaml" class="bare">https://raw.githubusercontent.com/openshift/tektoncd-pipeline-operator/master/deploy/resources/addons/02-clustertasks/buildah/buildah-task.yaml</a> \
  -f <a href="https://raw.githubusercontent.com/tektoncd/catalog/master/task/kn/0.1/kn.yaml" class="bare">https://raw.githubusercontent.com/tektoncd/catalog/master/task/kn/0.1/kn.yaml</a> \
  -f <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/workspaces/list-directory-task.yaml">$TUTORIAL_HOME/workspaces/list-directory-task.yaml</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>Check if all the tasks are available:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn task ls</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command should show an output like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME               DESCRIPTION              AGE
buildah            Buildah task builds...   11 hours ago
git-clone          These Tasks are Git...   11 hours ago
kn                 This Task performs ...   9 minutes ago
list-directory     Simple directory li...   11 hours ago
maven              This Task can be us...   11 hours ago</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="ws-deploy-nexus"><a class="anchor" href="#ws-deploy-nexus"></a>Deploy Nexus</h3>
<div class="paragraph">
<p>To show maven artifact caching and using customized maven <code>settings.xml</code> we will deploy Sonatype Nexus to the cluster:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n workspace-auth-demo \
  -f <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/install/utils/nexus.yaml" target="_blank" rel="noopener">$TUTORIAL_HOME/install/utils/nexus.yaml</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for the nexus3 pod to come up before proceeding further with exercises:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch kubectl -n workspace-auth-demo get pods,svc</code></pre>
</div>
</div>
<div class="paragraph">
<p>A sucessfully running nexus3 pod should show the following services and pods:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                         READY   STATUS    RESTARTS   AGE
pod/nexus-75fff8bbbd-cmlxs   1/1     Running   0          3m25s

NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
service/nexus        NodePort    10.100.205.22   &lt;none&gt;        8081:31743/TCP   3m25s</code></pre>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset1_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_minikube">
<div class="paragraph">
<p>The nexus maven repository could be opened using the url:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">minikube -p tektontutorial service nexus -n workspace-auth-demo --url</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">http://192.168.64.27:30102</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_openshift">
<div class="paragraph">
<p>In OpenShift we can use routes to expose the service if we need to access it from outside the cluster by:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc expose svc -n workspace-auth-demo nexus</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ws-create-maven-settings-cm"><a class="anchor" href="#ws-create-maven-settings-cm"></a>Create maven-settings ConfigMap</h3>
<div class="paragraph">
<p>For us to mount the maven <code>settings.xml</code>, we will create ConfigMap holding the custom maven settings.xml:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create -n workspace-auth-demo cm maven-settings \
  --from-file=settings.xml=<a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/workspaces/maven-settings.xml" target="_blank" rel="noopener">$TUTORIAL_HOME/workspaces/maven-settings.xml</a></code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">configmap/maven-settings created</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can check the ConfigMap contents using the command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get -n workspace-auth-demo cm maven-settings -o yaml \
    -o jsonpath='{.data}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of the above command should be same as in <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/workspaces/maven-settings.xml" target="_blank" rel="noopener">maven-settings.xml</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="ws-deploy-knative"><a class="anchor" href="#ws-deploy-knative"></a>Deploy Knative Serving</h3>
<div class="paragraph">
<p>As we will be deploying a <a href="https://knative.dev">Knative</a> serverless application as part of the pipeline, that we will be running later in this chapter, lets deploy Knative to the cluster:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset2_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_minikube">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Do it only once per cluster
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$TUTORIAL_HOME/bin/<a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/bin/enable_knative.sh" target="_blank" rel="noopener">enable_knative.sh</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for the serving deployment to complete without errors.</p>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_openshift">
<div class="paragraph">
<p>OpenShift users can install Knative by following the instructions <a href="https://docs.openshift.com/container-platform/4.6/serverless/installing_serverless/installing-openshift-serverless.html">here</a> for installing OpenShift Serverless.</p>
</div>
<div class="paragraph">
<p>Follow the instructions for installing the Serverless Operator on the cluster and then follow <a href="https://docs.openshift.com/container-platform/4.6/serverless/installing_serverless/installing-knative-serving.html#installing-knative-serving">the instructions for creating Knative Serving</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ws-check-sc"><a class="anchor" href="#ws-check-sc"></a>Check Default Storage Class</h3>
<div class="paragraph">
<p>Before we create our pipeline ensure that the kubernetes cluster has a default storage class defined:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get sc</code></pre>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset3_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_minikube">
<div class="paragraph">
<p>In minikube cluster it should show an output like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code>NAME                 PROVISIONER                RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
standard (default)   k8s.io/minikube-hostpath   Delete          Immediate           false                  44m</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_openshift">
<div class="paragraph">
<p>An example default storage class in Google Cloud:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                 PROVISIONER            RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
standard (default)   kubernetes.io/gce-pd   Delete          WaitForFirstConsumer   true                   2d3h</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>If you dont have one please check <a href="https://kubernetes.io/docs/concepts/storage/storage-classes/">Kubernetes Docs</a> on how to have one configured.</p>
</li>
<li>
<p>In OpenShift cluster the default storage class varies based on the underlying cloud platform. Refer to <a href="https://docs.openshift.com/container-platform/4.5/storage/dynamic-provisioning.html">OpenShift Documentation</a> to know more.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_create_pvc"><a class="anchor" href="#_create_pvc"></a>Create PVC</h3>
<div class="paragraph">
<p>Create the PVC <code>tekton-tutorial-sources</code>, which we will use as part of the exercises in this chapter and the upcoming ones.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n workspace-auth-demo -f <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/workspaces/sources-pvc.yaml" target="_blank" rel="noopener">$TUTORIAL_HOME/workspaces/sources-pvc.yaml</a></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ws-pipeline-overview"><a class="anchor" href="#ws-pipeline-overview"></a>Java Application Pipeline</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Java Application build pipeline will,</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Git clone using <code>git-clone</code> task, the <a href="https://github.com/redhat-scholars/tekton-tutorial-greeter" class="bare">https://github.com/redhat-scholars/tekton-tutorial-greeter</a> repo and build the <strong>springboot</strong> application</p>
</li>
<li>
<p>Will use maven task, maven task require two workspaces one for source and other for maven-settings</p>
</li>
<li>
<p>Build the container image using the <code>buildah</code> task and push to the internal container registry</p>
</li>
<li>
<p>Finally deploy the application onto Kubernetes using <code>openshift-client</code> task</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ws-use-pvc"><a class="anchor" href="#ws-use-pvc"></a>Using PVC As Workspace</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As part of this exercise we will use PersitenceVolume(PV) and PersistenceVolumeClaim(PVC) as Tekton workspace.</p>
</div>
<div class="sect2">
<h3 id="ws-use-pvc-git-clone"><a class="anchor" href="#ws-use-pvc-git-clone"></a>Git Clone TaskRun</h3>
<div class="paragraph">
<p>Since we will be using the same git repo for all the exercises, lets clone it. As git clone task requires <a href="https://github.com/tektoncd/catalog/blob/master/task/git-clone/0.1/git-clone.yaml#L21-L23"><code>output</code> workspace</a>, we will attach a PersistenceVolumeClaim to it.</p>
</div>
<div class="paragraph">
<p>Since the cluster as <strong>default</strong> Storage Class, just specifying the PersistenceVolumeClaim will  bind the PVC automatically to underlying storage. We will use the PVC <code>tekton-tutorial-sources</code> that we created earlier.</p>
</div>
<div class="paragraph">
<p>Let us run the <code>git-clone</code> Task with the <code>TaskRun</code> definition as shown below:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/workspaces/git-clone-taskrun.yaml" target="_blank" rel="noopener">git-clone-taskrun</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: tekton.dev/v1beta1
kind: TaskRun
metadata:
  generateName: git-clone- <i class="conum" data-value="1"></i><b>(1)</b>
  labels: <i class="conum" data-value="2"></i><b>(2)</b>
    tekton.dev/task: git-clone
spec:
  taskRef:
    name: git-clone
  params: <i class="conum" data-value="3"></i><b>(3)</b>
    - name: url
      value: https://github.com/redhat-scholars/tekton-tutorial-greeter
    - name: revision
      value: master
  workspaces: <i class="conum" data-value="4"></i><b>(4)</b>
    - name: output
      persistentVolumeClaim:
        claimName: tekton-tutorial-sources</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>As its required have unqiue name for each TaskRun we use create, as that will have new names genrated using <code>generateName</code> prefix</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Just marking this TaskRun as part of <code>git-clone</code> Task</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The GitHub Url and revision to use, for more details check the <a href="https://github.com/tektoncd/catalog/blob/master/task/git-clone/0.1/">Task</a></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Setting the workspace <code>output</code> mapped to PVC <code>tekton-tutorial-sources</code></td>
</tr>
</table>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset4_tkn"></a>tkn</p>
</li>
<li>
<p><a id="tabset4_kubectl"></a>kubectl</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset4_tkn">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn task start git-clone \
  --namespace=workspace-auth-demo \
  --param url=https://github.com/redhat-scholars/tekton-tutorial-greeter \
  --param revision=master \
  --param deleteExisting=true \
  --workspace name=output,claimName=tekton-tutorial-sources \
  --use-param-defaults \<i class="conum" data-value="1"></i><b>(1)</b>
  --showlog</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Makes the tkn CLI to use the default values from the task definiton without prompting for values</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The workspaces can be PVC or ConfigMap, Secret or emptyDir. The pattern to specify them are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>PVC</p>
<div class="ulist">
<ul>
<li>
<p><code>name=my-pvc,claimName=pvc1[,subPath=dir]</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Secret</p>
<div class="ulist">
<ul>
<li>
<p><code>name=my-secret,secret=secret-name</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Secret</p>
<div class="ulist">
<ul>
<li>
<p><code>name=my-config,config=rpg[,item=ultimav=1]</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>emptyDir</p>
<div class="ulist">
<ul>
<li>
<p><code>name=my-empty-dir,emptyDir=""</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset4_kubectl">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create -n workspace-auth-demo -f git-clone-taskrun.yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It will take few minutes for the TaskRun to start.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Watch the status of the Task run using:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn tr ls</code></pre>
</div>
</div>
<div class="paragraph">
<p>View the task run  logs using,</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn tr logs -f -a $(tkn tr ls -n workspace-auth-demo | awk 'NR==2{print $1}')</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also check the PVC is bound, as the git-clone-task output workspace is bound to it:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                      STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
tekton-tutorial-sources   Bound    pvc-48aa86ae-ec20-4f0c-a2d0-65d906d41bed   1Gi        RWO            standard       6s</code></pre>
</div>
</div>
<div class="paragraph">
<p>A successful git-clone TaskRun will show the following output:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[clone] + CHECKOUT_DIR=/workspace/output/
[clone] + '[[' false '==' true ]]
[clone] + test -z
[clone] + test -z
[clone] + test -z
[clone] + /ko-app/git-init -url https://github.com/redhat-scholars/tekton-tutorial-greeter -revision master -refspec  -path /workspace/output/ '-sslVerify=true' '-submodules=true' -depth 1
[clone] {"level":"info","ts":1595778607.616774,"caller":"git/git.go:139","msg":"Successfully cloned https://github.com/redhat-scholars/tekton-tutorial-greeter @ 2e3336657cc1bbf22e3db183a517dcb0a62207b9 (grafted, HEAD, origin/master) in path /workspace/output/"}
[clone] {"level":"info","ts":1595778607.6473103,"caller":"git/git.go:180","msg":"Successfully initialized and updated submodules in path /workspace/output/"}
[clone] + cd /workspace/output/
[clone] + git rev-parse+ tr -d '\n'
[clone]  HEAD
[clone] + RESULT_SHA=2e3336657cc1bbf22e3db183a517dcb0a62207b9
[clone] + EXIT_CODE=0
[clone] + '[' 0 '!=' 0 ]
[clone] + echo -n 2e3336657cc1bbf22e3db183a517dcb0a62207b9</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ws-use-pvc-listdir-run"><a class="anchor" href="#ws-use-pvc-listdir-run"></a>List Directory TaskRun</h3>
<div class="paragraph">
<p>As explained in the overview one of the advantages of the <code>workspaces</code> is that it can be shared, lets run a simple list-directory Task to verify the same:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/workspaces/list-dir-taskrun.yaml" target="_blank" rel="noopener">list-dir-taskrun.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: tekton.dev/v1beta1
kind: TaskRun
metadata:
  generateName: list-directory-
  labels:
    tekton.dev/task: list-directory
spec:
  taskRef:
    name: list-directory
  workspaces: <i class="conum" data-value="1"></i><b>(1)</b>
    - name: directory
      persistentVolumeClaim:
        claimName: tekton-tutorial-sources</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Notice that we bind the same PVC to workspace <code>directory</code> parameter of the <code>list-directory</code>.</td>
</tr>
</table>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset5_tkn"></a>tkn</p>
</li>
<li>
<p><a id="tabset5_kubectl"></a>kubectl</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset5_tkn">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn task start list-directory \
  --namespace=workspace-auth-demo \
  --workspace name=directory,claimName=tekton-tutorial-sources \
  --use-param-defaults \
  --showlog</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset5_kubectl">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create -n workspace-auth-demo -f list-dir-taskrun.yaml</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">taskrun.tekton.dev/list-directory-mbkvl created</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If all went well the list directory should show the directory listing of <a href="https://github.com/redhat-scholars/tekton-tutorial-greeter" class="bare">https://github.com/redhat-scholars/tekton-tutorial-greeter</a>.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[list-directory] total 44
[list-directory] drwxr-xr-x    3 root     root          4096 Aug 17 07:46 springboot
[list-directory] -rw-r--r--    1 root     root           515 Aug 17 07:46 settings.xml
[list-directory] drwxr-xr-x    3 root     root          4096 Aug 17 07:46 quarkus
[list-directory] -rw-r--r--    1 root     root           926 Aug 17 07:46 pom.xml
[list-directory] -rwxr-xr-x    1 root     root          6607 Aug 17 07:46 mvnw.cmd
[list-directory] -rwxr-xr-x    1 root     root         10069 Aug 17 07:46 mvnw
[list-directory] drwxr-xr-x    2 root     root          4096 Aug 17 07:46 k8s
[list-directory] -rw-r--r--    1 root     root           596 Aug 17 07:46 README.md

[show-readme] # Tekton Greeter
[show-readme]
[show-readme] Project used as part of [Tekton Tutorial](https://dn.dev/tekton-tutorial) execersies.
[show-readme]
[show-readme] The application has one simple REST api at URI `/` that says "Meeow from Tekton 😺 !! 🚀".
[show-readme]
[show-readme] ## Quarkus
[show-readme]
[show-readme] [Quarkus](./quarkus)
[show-readme]
[show-readme] ### Building locally
[show-readme]
[show-readme] ```shell
[show-readme] ./mvnw clean package -pl quarkus
[show-readme] ```
[show-readme]
[show-readme] ### Running locally
[show-readme]
[show-readme] ```shell
[show-readme] java -jar quarkus/target/quarkus-app/quarkus-run.jar
[show-readme] ```
[show-readme]
[show-readme] ## SpringBoot
[show-readme]
[show-readme] [SpringBoot](./quarkus)
[show-readme]
[show-readme] ### Building locally
[show-readme]
[show-readme] ```shell
[show-readme] ./mvnw clean package -pl springboot
[show-readme] ```
[show-readme]
[show-readme] ### Running locally
[show-readme]
[show-readme] ```shell
[show-readme] java -jar springboot/target/tekton-springboot-greeter.jar
[show-readme] ```</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ws-pvc-points-to-ponder"><a class="anchor" href="#ws-pvc-points-to-ponder"></a>Points to Ponder</h3>
<div class="ulist">
<ul>
<li>
<p>What is a workspace</p>
</li>
<li>
<p>How to bind a workspace to a TaskRun using PVC</p>
</li>
<li>
<p>How to share the workspace across multiple TaskRuns</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ws-use-cm"><a class="anchor" href="#ws-use-cm"></a>Using ConfigMap as Workspace</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As part of this exercise we will use and configure Tekton <code>workspace</code> with ConfigMap.</p>
</div>
<div class="sect2">
<h3 id="ws-use-cm-mvn-run"><a class="anchor" href="#ws-use-cm-mvn-run"></a>Run maven Task</h3>
<div class="paragraph">
<p>In this exercise, we will use maven-settings ConfigMap that we created earlier as one of workspace parameter <a href="https://github.com/tektoncd/catalog/blob/master/task/maven/0.1/maven.yaml#L16">maven-settings</a> and for the <a href="https://github.com/tektoncd/catalog/blob/master/task/maven/0.1/maven.yaml#L15">source</a> workspace paramter we use the <code>tekton-tutorial-sources</code> PVC.</p>
</div>
<div class="paragraph">
<p>Let run the maven task to build the tekton-greeter project we cloned earlier.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/workspaces/maven-taskrun.yaml" target="_blank" rel="noopener">maven-taskrun.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: tekton.dev/v1beta1
kind: TaskRun
metadata:
  generateName: maven-build-
  labels:
    tekton.dev/task: maven
spec:
  taskRef:
    name: maven
  params:
    - name: GOALS <i class="conum" data-value="1"></i><b>(1)</b>
      value:
        - -B
        - -pl
        - springboot
        - -DskipTests
        - clean
        - package
  workspaces:
    - name: maven-settings
      configmap: <i class="conum" data-value="2"></i><b>(2)</b>
        name: maven-settings
    - name: source
      persistentVolumeClaim: <i class="conum" data-value="3"></i><b>(3)</b>
        claimName: tekton-tutorial-sources</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specifying the maven goals to be run as a part of the build</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure the maven-settings configmap to be used for <code>maven-settings</code> workspace</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configure the tekton-tutorial-sources PVC to be used for <code>source</code> workspace</td>
</tr>
</table>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset6_tkn"></a>tkn</p>
</li>
<li>
<p><a id="tabset6_kubectl"></a>kubectl</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset6_tkn">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn task start maven \
  --namespace=workspace-auth-demo \
  --param GOALS='-pl,springboot,-B,-DskipTests,clean,package' \
  --workspace name=maven-settings,config=maven-settings \
  --workspace name=source,claimName=tekton-tutorial-sources \
  --use-param-defaults \
  --showlog</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset6_kubectl">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create -n workspace-auth-demo -f maven-taskrun.yaml</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">taskrun.tekton.dev/maven-build-9cjws created</code></pre>
</div>
</div>
<div class="paragraph">
<p>View the task run  logs using,</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn tr logs -f -a $(tkn tr ls -n workspace-auth-demo | awk 'NR==2{print $1}')</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A successfull run should have output like(output trimmed for brevity):</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">...
[mvn-goals] [INFO] Downloaded from nexus: http://nexus:8081/repository/maven-public/org/eclipse/sisu/org.eclipse.sisu.plexus/0.3.4/org.eclipse.sisu.plexus-0.3.4.jar (205 kB at 1.0 MB/s)
[mvn-goals] [INFO] Downloaded from nexus: http://nexus:8081/repository/maven-public/org/eclipse/sisu/org.eclipse.sisu.inject/0.3.4/org.eclipse.sisu.inject-0.3.4.jar (379 kB at 1.9 MB/s)
[mvn-goals] [INFO] Downloaded from nexus: http://nexus:8081/repository/maven-public/org/codehaus/plexus/plexus-classworlds/2.6.0/plexus-classworlds-2.6.0.jar (53 kB at 259 kB/s)
[mvn-goals] [INFO] Downloaded from nexus: http://nexus:8081/repository/maven-public/org/sonatype/plexus/plexus-build-api/0.0.7/plexus-build-api-0.0.7.jar (8.5 kB at 40 kB/s)
[mvn-goals] [INFO] Replacing main artifact with repackaged archive
[mvn-goals] [INFO] ------------------------------------------------------------------------
[mvn-goals] [INFO] BUILD SUCCESS
[mvn-goals] [INFO] ------------------------------------------------------------------------
[mvn-goals] [INFO] Total time:  8.572 s
[mvn-goals] [INFO] Finished at: 2020-08-17T08:20:22Z
[mvn-goals] [INFO] ------------------------------------------------------------------------
...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When the TaskRun runs for the first , it will run loner as  it will maven artifacts for the first time and caches the artifacts nexus repository manager. Try running the command again to see it will run a lot quicker.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ws-use-cm-list-target-dir"><a class="anchor" href="#ws-use-cm-list-target-dir"></a>List build target directory</h3>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset7_tkn"></a>tkn</p>
</li>
<li>
<p><a id="tabset7_kubectl"></a>kubectl</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset7_tkn">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn task start list-directory \
  --namespace=workspace-auth-demo \
  --param sub-dirs='springboot/target' \
  --workspace name=directory,claimName=tekton-tutorial-sources \
  --use-param-defaults \
  --showlog</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset7_kubectl">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create -n workspace-auth-demo -f <a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/workspaces/list-target-dir-taskrun.yaml">list-target-dir-taskrun.yaml</a></code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">taskrun.tekton.dev/list-directory-xbzpq created</code></pre>
</div>
</div>
<div class="paragraph">
<p>View the task run  logs using,</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn tr logs -f -a $(tkn tr ls -n workspace-auth-demo | awk 'NR==2{print $1}')</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A successful command should show the following output:</p>
</div>
<div class="paragraph">
<p>The output(trimmed for brevity) of the command should be like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[list-directory] total 18020
[list-directory] drwxr-xr-x    3 root     root          4096 Aug 17 08:21 maven-status
[list-directory] drwxr-xr-x    3 root     root          4096 Aug 17 08:21 generated-sources
[list-directory] drwxr-xr-x    3 root     root          4096 Aug 17 08:21 test-classes
[list-directory] drwxr-xr-x    3 root     root          4096 Aug 17 08:21 generated-test-sources
[list-directory] drwxr-xr-x    3 root     root          4096 Aug 17 08:21 classes
[list-directory] -rw-r--r--    1 root     root          3748 Aug 17 08:21 tekton-springboot-greeter.jar.original
[list-directory] drwxr-xr-x    2 root     root          4096 Aug 17 08:21 maven-archiver
[list-directory] -rw-r--r--    1 root     root      18421378 Aug 17 08:21 tekton-springboot-greeter.jar
...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="use-cm-points-to-ponder"><a class="anchor" href="#use-cm-points-to-ponder"></a>Points to Ponder</h3>
<div class="ulist">
<ul>
<li>
<p>How to mount a ConfigMap as workspace</p>
</li>
<li>
<p>Use the workspace across TaskRuns in this case used the git-clone output in maven build using <code>tekton-tutorial-sources</code> PVC as workspace</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ws-deploy-pipeline"><a class="anchor" href="#ws-deploy-pipeline"></a>Deploy Pipeline</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let us now apply what we learned with workspace to build and deploy the application pipeline as shown:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/workspaces/greeter-app-deploy.yaml" target="_blank" rel="noopener">greeter-app-deploy.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: greeter-app-deploy
spec:
  description: &gt;-
    The Pipeline to build and deploy the Hello World Java App
    <a href="https://github.com/redhat-scholars/tekton-tutorial-greeter" class="bare">https://github.com/redhat-scholars/tekton-tutorial-greeter</a> as Knative
    Service.
  params:
    - description: &gt;-
        The fully qualified image name. If you are running on Minikube please
        use example.com/tekton-tutorial/greeter On OpenShift, use
        image-registry.openshift-image-registry.svc:5000/workspace-auth-demo/tekton-tutorial-greeter
      default: image-registry.openshift-image-registry.svc:5000/workspace-auth-demo/tekton-tutorial-greeter
      name: image-name <i class="conum" data-value="1"></i><b>(1)</b>
      type: string
    - description: &gt;-
        The application framework to use, value can be either quarkus or
        springboot
      name: context-dir
      type: string
    - default: greeter
      description: The Knative Service name
      name: kn-service-name
      type: string
    - default: 'https://github.com/redhat-scholars/tekton-tutorial-greeter'
      description: The GitHub Repo of the Java Application
      name: github-repo-url
      type: string
    - default: staging
      description: The GitHub revision to use
      name: github-repo-revision
      type: string
    - name: storageDriver
      type: string
      description: Use storage driver type vfs if you are running on OpenShift.
      default: vfs
  workspaces:
    - name: source <i class="conum" data-value="2"></i><b>(2)</b>
    - name: maven-settings <i class="conum" data-value="3"></i><b>(3)</b>
  tasks:
    - name: clone-sources
      params:
        - name: url
          value: $(params.github-repo-url)
        - name: revision
          value: $(params.github-repo-revision)
        - name: deleteExisting
          value: 'true'
      taskRef:
        kind: Task
        name: git-clone
      workspaces:
        - name: output
          workspace: source
    - name: build-java-test
      params:
        - name: GOALS
          value:
            - '-pl'
            - $(params.context-dir)
            - '-B'
            - clean
            - test
      runAfter:
        - clone-sources
      taskRef:
        kind: Task
        name: maven
      workspaces:
        - name: maven-settings
          workspace: maven-settings
        - name: source
          workspace: source
    - name: build-java-app
      params:
        - name: GOALS
          value:
            - '-pl'
            - $(params.context-dir)
            - '-B'
            - '-DskipTests'
            - clean
            - package
      runAfter:
        - build-java-test
      taskRef:
        kind: Task
        name: maven
      workspaces:
        - name: maven-settings
          workspace: maven-settings
        - name: source
          workspace: source
    - name: build-java-app-image
      params:
        - name: CONTEXT
          value: $(params.context-dir)
        - name: IMAGE
          value: $(params.image-name)
        - name: STORAGE_DRIVER
          value: $(params.storageDriver)
        - name: TLSVERIFY
          value: 'false'
      runAfter:
        - build-java-app
      taskRef:
        kind: ClusterTask
        name: buildah
      workspaces:
        - name: source
          workspace: source
    - name: deploy-kn-service
      params:
        - name: ARGS
          value:
            - service
            - create
            - $(params.kn-service-name)
            - '--force'
            - &gt;-
              --image=$(params.image-name)@$(tasks.build-java-app-image.results.IMAGE_DIGEST) <i class="conum" data-value="4"></i><b>(4)</b>
      runAfter:
        - build-java-app-image
      taskRef:
        kind: Task
        name: kn</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The parameters for the Pipeline</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A workspace named <code>source</code>, we will map it to the PVC`tekton-tutorial-sources`  in PipelineRun in upcoming section</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A workspace named <code>maven-settings</code>, we will map it to ConfigMap <code>maven-settings</code> in the PipelineRun in upcoming section</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>buildah</code> build image task returns a output. We use the that as part of the <code>--image</code> parameter to <code>kn</code> Task</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="ws-create-pipeline"><a class="anchor" href="#ws-create-pipeline"></a>Create the Pipeline</h3>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n workspace-auth-demo -f greeter-app-deploy.yaml</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">pipeline.tekton.dev/greeter-app-deploy created</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_service_account"><a class="anchor" href="#_create_service_account"></a>Create Service Account</h3>
<div class="paragraph">
<p>We need to create the Service Account(SA) that is authorized to Knative Service deployments. To create the SA run:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -sSL \
  <a href="https://raw.githubusercontent.com/tektoncd/catalog/master/task/kn/0.1/support/kn-deployer.yaml" class="bare">https://raw.githubusercontent.com/tektoncd/catalog/master/task/kn/0.1/support/kn-deployer.yaml</a> \
  | yq '.metadata.namespace="workspace-auth-demo"' \
  | kubectl apply -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>The successful command should show an output like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">serviceaccount/kn-deployer-account created
clusterrole.rbac.authorization.k8s.io/kn-deployer created
clusterrolebinding.rbac.authorization.k8s.io/kn-deployer-binding created</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ws-run-pipeline"><a class="anchor" href="#ws-run-pipeline"></a>Run the Pipeline</h3>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset8_tkn"></a>tkn</p>
</li>
<li>
<p><a id="tabset8_kubectl"></a>kubectl</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset8_tkn">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn pipeline start greeter-app-deploy \
  --namespace=workspace-auth-demo \
  --serviceaccount=kn-deployer-account \
  --param context-dir='quarkus' \
  --workspace name=maven-settings,config=maven-settings \
  --workspace name=source,claimName=tekton-tutorial-sources \
  --showlog</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset8_kubectl">
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-scholars/tekton-tutorial/blob/master/workspaces/greeter-app-deploy-run.yaml" target="_blank" rel="noopener">greeter-app-deploy-run.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  generateName: greeter-app-
  labels:
    tekton.dev/pipeline: greeter-app-deploy
spec:
  serviceAccountName: kn-deployer-account <i class="conum" data-value="1"></i><b>(1)</b>
  pipelineRef:
    name: greeter-app-deploy
  params:
    - name: context-dir
      value: quarkus
# enable this for OpenShift
#    - name: storageDriver
#      value: vfs
  workspaces: <i class="conum" data-value="2"></i><b>(2)</b>
    - name: maven-settings
      configmap:
        name: maven-settings
    - name: source
      persistentVolumeClaim:
        claimName: tekton-tutorial-sources</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create -n workspace-auth-demo -f greeter-app-deploy-run.yaml</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">pipelinerun.tekton.dev/greeter-app-7k9cw created</code></pre>
</div>
</div>
<div class="paragraph">
<p>View the pipeline run logs using,</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tkn pr logs -f -a $(tkn pr ls -n workspace-auth-demo | awk 'NR==2{print $1}')</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A successful Pipelinerun should have the <code>greeter</code> application up and running as shown:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kn service describe -n workspace-auth-demo greeter</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command should show an output like :</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Name:       greeter
Namespace:  workspace-auth-demo
Age:        21s
<mark>URL:        http://greeter.workspace-auth-demo.192.168.64.7.nip.io</mark>

Revisions:
  100%  @latest (greeter-ttyqz-1) [1] (21s)
        Image:  example.com/tekton-tutorial/greeter@sha256:79b8a50a6ef29dbc0df5220de5aea13b8b38b7c4cd407ad074968de8cfbd41b6 (at 79b8a5)

Conditions:
  OK TYPE                   AGE REASON
  ++ Ready                  13s
  ++ ConfigurationsReady    14s
  ++ RoutesReady            13s</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ws-verify-service"><a class="anchor" href="#ws-verify-service"></a>Verify Deployed Service</h3>
<div class="paragraph">
<p>Let us now verify the deployed Knative Service:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">KSVC_URL=$(kn service describe -n workspace-auth-demo greeter -o url)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now do a invoke the service like:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">http --body $KSVC_URL</code></pre>
</div>
</div>
<div class="paragraph">
<p>A successfull pipeline deployment should show an output like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text"><strong>Tekton 😺 rocks 🚀</strong></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tekton-ws-cleanup"><a class="anchor" href="#tekton-ws-cleanup"></a>Cleanup</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Leave the namespace, nexus, pvc, confimaps created as part of this chapter, as we will be reusing them in next chapter.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$TUTORIAL_HOME/bin/cleanup.sh workspace-auth-demo</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="pipelines.html">Pipelines</a></span>
  <span class="next"><a href="private_reg_repos.html">Private Registries and Repositories</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
